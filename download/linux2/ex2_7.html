<HTML>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <TITLE>Example 15</TITLE>
</head>
<body >
<a href=l2_7.html#ex>Назад</a>
<hr>
<table><tr><td><img src=slTandy.gif>&nbsp;&nbsp;&nbsp;&nbsp;</td>
<td><h3>Пример выполнения лабораторной работы N15</h3></td></tr></table>
<p>В этой модели деятельность Слонов носит более коллективистский характер. 
<p>Каждый Слон ищет воду самостоятельно. Однако, найдя водоем, Слон сравнивает 
свою потребность с объемом водоема. Если его потребность меньше, чем объем 
водоема, Слон отправляет Ганеше сообщение, в котором указывает, сколько 
"лишней" воды он нашел. Ганеша находит в списке Слонов того Слона, который в 
настоящее время находится в поиске и имеет наибольшую потребность в воде, и 
направляет этого Слона к водоему, найденному его товарищем.
<p>В отличие от предыдущих моделей, мы не применяем здесь "жесткого" 
прекращения деятельности Слонов: если сообщение о прекращении деятельности 
приходит к Слону в тот момент, когда он потребляет воду, Слон имеет 
возможность закончить потребление и, если после этого его потребность будет 
удовлетворена полностью, завершиться нормально.

<p>В реализации этой модели передача информации между процессами происходит через очереди сообщений. Все Слоны посылают свои сообщения Ганеше в одну очередь, идентификатор которой представлен переменной <samp>msgGaneshaId</samp>. Для каждого Слона имеется собственная очередь, в которую Ганеша направляет сообщения, адресованные именно этому Слону. Идентификаторы этих очередей в программе процесса-Ганеши составляют массив <samp>msgId[]</samp>. Все очереди создает процесс-Ганеша и передает идентификаторы очередей дочернему процессу через параметры программы.

<p>Предусмотрены два типа сообщений, которые процесс-Ганеша может отправлять процессам-Слонам:
<p><table border align=center>
<tr>
<td align=center><b> Числовой тип сообщения </b></td>
<td align=center><b> Символьное обозначение типа </b></td>
<td align=center><b> Назначение сообщения </b></td>
<td align=center><b> Содержание сообщения </b></td>
</tr>
<tr>
<td valign=top align=center>1</td>
<td valign=top align=center><samp>GRANT</samp></td>
<td valign=top>Сообщение о том, что Слону выделяется некоторый объем воды, 
    найденной другим Слоном</td>
<td valign=top >Число - объем выделяемой порции</td>
</tr>
<tr>
<td valign=top align=center>2</td>
<td valign=top align=center><samp>TERM</samp></td>
<td valign=top>Требование Слону прекратить деятельность </td>
<td valign=top >&lt;<I>пустое</I>&gt; </td>
</tr>
</table>

<p>Предусмотрены четыре типа сообщений, которые процесс-Слон может отправлять 
   процессу-Ганеше:
<p><table border align=center>
<tr>
<td align=center><b> Числовой тип сообщения </b></td>
<td align=center><b> Символьное обозначение типа </b></td>
<td align=center><b> Назначение сообщения </b></td>
<td align=center><b> Содержание сообщения </b></td>
</tr>
<tr>
<td valign=top align=center>1</td>
<td valign=top align=center><samp>NEED</samp></td>
<td valign=top> Отправляется в начале деятельности Слона и при каждом 
    изменении его потребности </td>
<td valign=top> Имя Слона &lt;<I>пробел</I>&gt; Число - размер 
    потребности Слона </td>
</tr>
<tr>
<td valign=top align=center>2</td>
<td valign=top align=center><samp>SUCC</samp></td>
<td valign=top> Сообщение о том, что Слона приступил к водопою (независимо от 
    того, нашел он воду сам или получил от другого Слона) </td>
<td valign=top> Имя Слона </td>
</tr>
<tr>
<td valign=top align=center>3</td>
<td valign=top align=center><samp>REST</samp></td>
<td valign=top> Сообщение о том, что у Слона имеется избыток воды; 
    отправляется Слоном при нахождении водоема, объем которого превышает 
    потребность Слона </td>
<td valign=top> Имя Слона &lt;<I>пробел</I>&gt; Число - размер избытка </td>
</tr>
<tr>
<td valign=top align=center>4</td>
<td valign=top align=center><samp>FINISH</samp></td>
<td valign=top> Сообщение о том, что Слона удовлетворил свою потребность 
    и закончил деятельность </td>
<td valign=top> Имя Слона </td>
</tr>
</table>

<p>Еще одна новая структура данных в этой программной модели - список резерва.
   Когда Ганеша получает от Слона сообщение о наличии избытка воды и не находит
   Слона, которому этот избыток можно перенаправить, Ганеша заносит полученную
   порцию в список резерва. Этот список организован как связный линейный список
   с обработкой LIFO, указатель на начало списка - переменная <samp>pList</samp>.

<p>После создания очередей и запуска процессов-Слонов алгоритм деятельности
   Ганеши сводится к следующему: 
<ul>
   <li>Ганеша устанавливает "будильник" на 10 сек (системным вызовом 
   <a href=./man/_alarm.html>alarm</a>).
   <li>Ганеша входит в цикл, который повторяется до поступления сигнала от
       будильника.
   <li>В каждой итерации цикла Ганеша читает одно сообщение из своей входной
       очереди. Если сообщений во входной очереди нет, Ганеша переводится в
       состояние ожидания - до появления сообщения в очереди.
   <li>Получив сообщение, Ганеша выполняет его синтаксический разбор выделяет имя
       Слона и, при необходимости, числовой параметр сообщения) и находит по
       своему списку Слона, приславшего сообщение. Дальнейшая обработка
       зависит от типа сообщения.
   <li>Для сообщения <samp>NEED</samp> Ганеша устанавливает в своем массиве
       <samp>need</samp> значение потребности данного Слона. Если список резерва
       непустой, Ганеша отправляет этому Слону сообщение типа <samp>GRANT</samp>
       о выделении ему порции из резерва. 
   <li>Для сообщения <samp>SUCC</samp> Ганеша устанавливает в своем массиве
       <samp>need</samp> значение потребности данного Слона в -1. Это означает
       что данный Слон не является претендентом на получение "дотации".
   <li>Для сообщения <samp>FINISH</samp> Ганеша устанавливает в своем массиве
       <samp>need</samp> значение потребности данного Слона в 0. Этот
       Слон считается успешно завершившимся.
   <li>Для сообщения <samp>REST</samp> Ганеша определяет размер полученной от
       Слона порции и выполняет в своем списке Слонов поиск Слона с максимальной
       потребностью. При поиске не рассматриваются Слоны с потребностью 0 
       (уже напившиеся) и с потребностью -1 (пьющие в настоящий момент). Если
       Слон-претендент найден, Ганеша отправляет этому Слону сообщение типа <samp>GRANT</samp>
       о выделении ему полученной порции. Если Слон-претендент не найден, 
       Ганеша добавляет полученную порцию в список резерва.
   <li>Сигнал будильника прерывает выполнение цикла (в том числе, и ожидание
       поступления сообщения). Этот сигнал обрабатывается функцией <samp>hAlrm</samp>,
       которая устанавливает в 1 признак поступления сигнала <samp>Alarm</samp>
       "длинный переход" (<samp><a href=./man/_longjmp.html>longjmp</a></samp>) на
       точку перед началом описанного выше цикла. Поскольку признак поступления сигнала
       установлен в 1, цикл больше не выполняется.
   <li>Выйдя таким образом из цикла, процесс-Ганеша посылает всем еще не 
       закончившимся процессам-Слонам сообщение <samp>TERM</samp>, дожидается 
       завершения всех процессов, уничтожает все очереди, освобождает список
       резерва и завершается сам.
</ul>

<p>Алгоритм выполнения процесса-Слона состоит в следующем:
<ul>
   <li>Запустившись, процесс-Слон принимает параметры запуска, определяет свою
       потребность и отправляет процессу-Ганеше сообщение <samp>NEED</samp>.
   <li>Слон входит в цикл, который продолжается до тех пор, пока его потребность 
       не уменьшится до 0.
   <li>В каждой итерации цикла Слон проверяет поступление сообщения <samp>TERM</samp>
       в его входную очередь. Особенности выполнения этой операции следующие:
       <ul>
       <li>проверяется только сообщение данного типа;
       <li>проверка производится без ожидания сообщения, если сообщения 
           указанного типа в очереди нет, вызов <a href=./man/_msgrcv.html>msgrcv</a>
           завершается немедленно;
       <li>сообщение <samp>TERM</samp> проверяется в начале каждой итерации цикла,
           таким образом, оно имеет приоритет перед сообщениями других типов.
       </ul>
   <li>Если сообщение <samp>TERM</samp> поступило, происходит досрочный выход 
       из цикла.
   <li>Если сообщение <samp>TERM</samp> не поступило, проверяется поступление 
       во входную очередь сообщения <samp>GRANT</samp> (также без ожидания).
   <li>Если сообщение <samp>GRANT</samp> поступило, выполняется функция
       <samp>success</samp> (см. ниже).
   <li>Если сообщение <samp>GRANT</samp> не поступило, "разыгрывается" нахождение
       порции воды (случайное число из диапазона 0 - 49 должно быть меньше 2).
   <li>Если порция воды найдена, определяется как случайное число ее размер и 
       выполняется функция <samp>success</samp>. Если порция воды не найдена, 
       выполняется задержка на 100 мксек - перед следующей попыткой поиска.
   <li>После выхода из цикла (при удовлетворении потребности или при получении
       сообщения <samp>TERM</samp> процесс-Слон завершается.
</ul>
<p>Функция <samp>success</samp> выполняется при получении Слоном очередной 
   порции воды - найденной самостоятельно или полученной в сообщении <samp>GRANT</samp>.
   При ее выполнении:
<ul>
  <li>Слон посылает процессу-Ганеше сообщение типа <samp>SUCC</samp>.
  <li>Если полдученная порция превышает потребность Слона, он посылает 
      процессу-Ганеше сообщение типа <samp>REST</samp> с указанием избытка.
  <li>Выполняет задержку на "потребление" порции.
  <li>После потребления уменьшает свою потребность на размер потребленной порции.
  <li>Если потребность Слона сократилась до 0, Слон посылает сообщение <samp>FINISH</samp>,
      в противном случае Слон посылает сообщение <samp>NEED</samp> с указанием нового 
      размера своей потребности.
</ul>
<p>Программный модуль, реализующий деятельность Ганеши (<a href="./man/Prog/lw15/ganesha7.c">ganesha7.c</a> ) и программный модуль, реализующий деятельность 
одного Слона (<a href="./man/Prog/lw15/elephant7.c">elephant7.c</a>) см. в /home/Metod/OS/2010/Lab_2010/Part_2/man/Prog/lw15.

		<p>
		В программах используються следующие вызовы:
		<ul>
		<li><a href=./man/_longjmp.html>longjmp()</a>
		<li><a href=./man/_signal.html>signal()</a>
		<li><a href=./man/_msgget.html>msgget()</a>
		<li><a href=./man/_perror.html>perror()</a>
		<li><a href=./man/_alarm.html>alarm()</a>
		<li><a href=./man/_longjmp.html>setjmp()</a>
		<li><a href=./man/_msgrcv.html>msgrcv()</a>
		<li><a href=./man/_msgsnd.html>msgsnd()</a>
		<li><a href=./man/_wait.html>wait()</a>
		 <li><a href=./man/_msgctl.html>msgctl()</a>
	</ul>
         



 <p>Ниже приводится пример выполнения этой модели
<p><table border align=center>
<tr><td>
<pre>
  11:18:13.578 - Начало работы
  11:18:13.632 Ganesa: получено сообщение type=NEED &gt;Maya 92&lt;
  11:18:13.634 Ganesa: получено сообщение type=NEED &gt;Assam 168&lt;
  11:18:13.634 Ganesa: получено сообщение type=NEED &gt;Tandy 14&lt;
  11:18:13.635 Ganesa: получено сообщение type=NEED &gt;Hao 51&lt;
  11:18:13.635 Ganesa: получено сообщение type=NEED &gt;BakZap 101&lt;&nbsp;&nbsp;
  11:18:13.636 Ganesa: получено сообщение type=NEED &gt;Aun 24&lt;
  11:18:13.636 Ganesa: получено сообщение type=NEED &gt;Hathy 238&lt;
  11:18:13.643 Ganesa: получено сообщение type=NEED &gt;Kitty 45&lt;
  11:18:14.330 Maya нашел -30
  11:18:14.331 Ganesa: получено сообщение type=SUCC &gt;Maya&lt;
  11:18:14.340 Tandy нашел -30
  11:18:14.342 Ganesa: получено сообщение type=SUCC &gt;Tandy&lt;
  11:18:14.342 Ganesa: получено сообщение type=REST &gt;Tandy 16&lt;
  11:18:14.342 Assam нашел -30
  11:18:14.344 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:14.350 Hathy: получено сообщение type=GRANT &gt;16&lt;
  11:18:14.352 Hao нашел -30
  11:18:14.353 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:14.354 Ganesa: получено сообщение type=SUCC &gt;Hao&lt;
  11:18:14.360 BakZap нашел -30
  11:18:14.362 Ganesa: получено сообщение type=SUCC &gt;BakZap&lt;
  11:18:14.362 Aun нашел -30
  11:18:14.363 Ganesa: получено сообщение type=SUCC &gt;Aun&lt;
  11:18:14.364 Ganesa: получено сообщение type=REST &gt;Aun 6&lt;
  11:18:14.364 Kitty: получено сообщение type=GRANT &gt;6&lt;
  11:18:14.366 Ganesa: получено сообщение type=SUCC &gt;Kitty&lt;
  11:18:15.130 Ganesa: получено сообщение type=NEED &gt;Hathy 222&lt;
  11:18:15.150 Hathy нашел -30
  11:18:15.150 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:15.530 Ganesa: получено сообщение type=NEED &gt;BakZap 71&lt;
  11:18:15.570 Ganesa: получено сообщение type=NEED &gt;Kitty 39&lt;
  11:18:15.590 Kitty нашел -30
  11:18:15.590 Ganesa: получено сообщение type=SUCC &gt;Kitty&lt;
  11:18:15.850 Ganesa: получено сообщение type=NEED &gt;Assam 138&lt;
  11:18:15.970 Ganesa: получено сообщение type=NEED &gt;Maya 62&lt;
  11:18:15.990 BakZap нашел -40
  11:18:15.990 Ganesa: получено сообщение type=SUCC &gt;BakZap&lt;
  11:18:16.310 Assam нашел -40
  11:18:16.310 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:16.430 Maya нашел -40
  11:18:16.430 Ganesa: получено сообщение type=SUCC &gt;Maya&lt;
  11:18:16.590 Ganesa: получено сообщение type=NEED &gt;Hathy 192&lt;
  11:18:17.050 Hathy нашел -40
  11:18:17.050 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:17.540 Ganesa: получено сообщение type=NEED &gt;BakZap 31&lt;
  11:18:17.660 BakZap нашел -4
  11:18:17.660 Ganesa: получено сообщение type=SUCC &gt;BakZap&lt;
  11:18:17.830 Ganesa: получено сообщение type=NEED &gt;BakZap 27&lt;
  11:18:17.890 BakZap нашел -39
  11:18:17.890 Ganesa: получено сообщение type=SUCC &gt;BakZap&lt;
  11:18:17.890 Ganesa: получено сообщение type=REST &gt;BakZap 12&lt;
  11:18:18.320 Ganesa: получено сообщение type=NEED &gt;Assam 98&lt;
  11:18:18.320 Assam: получено сообщение type=GRANT &gt;12&lt;
  11:18:18.321 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:18.610 Ganesa: получено сообщение type=NEED &gt;Maya 22&lt;
  11:18:18.650 Ganesa: получено сообщение type=NEED &gt;Hao 21&lt;
  11:18:18.730 Maya нашел -4
  11:18:18.730 Ganesa: получено сообщение type=SUCC &gt;Maya&lt;
  11:18:18.930 Ganesa: получено сообщение type=NEED &gt;Assam 86&lt;
  11:18:18.940 Слон BakZap закончил водопой
  11:18:18.941 Ganesa: получено сообщение type=FINISH &gt;BakZap&lt;
  11:18:18.960 Ganesa: получено сообщение type=NEED &gt;Maya 18&lt;
  11:18:18.970 Ganesa: получено сообщение type=NEED &gt;Hathy 152&lt;
  11:18:19.020 Maya нашел -39
  11:18:19.020 Ganesa: получено сообщение type=SUCC &gt;Maya&lt;
  11:18:19.020 Ganesa: получено сообщение type=REST &gt;Maya 21&lt;
  11:18:19.030 Hathy: получено сообщение type=GRANT &gt;21&lt;
  11:18:19.030 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:19.050 Assam нашел -4
  11:18:19.050 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:19.110 Hao нашел -40
  11:18:19.110 Ganesa: получено сообщение type=SUCC &gt;Hao&lt;
  11:18:19.110 Ganesa: получено сообщение type=REST &gt;Hao 19&lt;
  11:18:19.260 Ganesa: получено сообщение type=NEED &gt;Assam 82&lt;
  11:18:19.260 Assam: получено сообщение type=GRANT &gt;19&lt;
  11:18:19.260 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:20.010 Слон Maya закончил водопой
  11:18:20.010 Ganesa: получено сообщение type=FINISH &gt;Maya&lt;
  11:18:20.040 Ganesa: получено сообщение type=NEED &gt;Hathy 131&lt;
  11:18:20.100 Hathy нашел -4
  11:18:20.100 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:20.220 Ganesa: получено сообщение type=NEED &gt;Assam 63&lt;
  11:18:20.280 Assam нашел -39
  11:18:20.280 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:20.310 Ganesa: получено сообщение type=NEED &gt;Hathy 127&lt;
  11:18:20.370 Hathy нашел -39
  11:18:20.370 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:21.600 Ganesa: получено сообщение type=NEED &gt;Kitty 9&lt;
  11:18:22.060 Kitty нашел -40
  11:18:22.060 Ganesa: получено сообщение type=SUCC &gt;Kitty&lt;
  11:18:22.060 Ganesa: получено сообщение type=REST &gt;Kitty 31&lt;
  11:18:22.120 Слон Hao закончил водопой
  11:18:22.120 Ganesa: получено сообщение type=FINISH &gt;Hao&lt;
  11:18:22.240 Ganesa: получено сообщение type=NEED &gt;Hathy 88&lt;
  11:18:22.240 Ganesa: получено сообщение type=NEED &gt;Assam 24&lt;
  11:18:22.260 Hathy: получено сообщение type=GRANT &gt;31&lt;
  11:18:22.260 Ganesa: получено сообщение type=SUCC &gt;Hathy&lt;
  11:18:22.420 Assam нашел -48
  11:18:22.420 Ganesa: получено сообщение type=SUCC &gt;Assam&lt;
  11:18:22.420 Ganesa: получено сообщение type=REST &gt;Assam 24&lt;
  11:18:23.630 ВРЕМЯ ОЖИДАНИЯ ИСТЕКЛО
  11:18:23.630 Слон Assam закончил водопой
  11:18:23.690 Слон Tandy закончил водопой
  11:18:23.750 Hathy: получено сообщение type=TERM &gt;TERM&lt;
  11:18:23.750 Слон Hathy погиб
  11:18:23.870 Слон Kitty закончил водопой
  11:18:26.370 Слон Aun закончил водопой</pre></td></tr>
</table>
<p></p>               
<hr>   
<a href=l2_7.html#ex>Назад</a>
</body>
</html>
